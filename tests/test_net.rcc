import { httpGet, httpPost, tcpConnect, tcpWrite, tcpRead, tcpClose } from "std:net";
import { log } from "std:console";

// Test HTTP GET request
async fn testHttpGet(): void {
    log("Testing HTTP GET request...");

    // Simple HTTP request to a public API
    let response = await httpGet("http://httpbin.org/get");

    if (response != null) {
        log("HTTP GET Response received:");
        log(response);
    } else {
        log("HTTP GET request failed");
    }
}

// Test HTTP POST request
async fn testHttpPost(): void {
    log("\nTesting HTTP POST request...");

    let jsonBody = '{"name":"Raccoon","version":"0.1.0"}';
    let response = await httpPost("http://httpbin.org/post", jsonBody);

    if (response != null) {
        log("HTTP POST Response received:");
        log(response);
    } else {
        log("HTTP POST request failed");
    }
}

// Test TCP client connection
async fn testTcpClient(): void {
    log("\nTesting TCP client...");

    // Connect to a TCP echo server (example.com:80)
    let handle = await tcpConnect("example.com:80");

    if (handle >= 0) {
        log("Connected to server with handle: " + str(handle));

        // Send HTTP request
        let httpRequest = "GET / HTTP/1.1\r\nHost: example.com\r\nConnection: close\r\n\r\n";
        let writeSuccess = await tcpWrite(handle, httpRequest);

        if (writeSuccess) {
            log("Data sent successfully");

            // Read response
            let response = await tcpRead(handle);
            if (response != null) {
                log("Response received:");
                log(response);
            }
        } else {
            log("Failed to send data");
        }

        // Close connection
        let closed = await tcpClose(handle);
        if (closed) {
            log("Connection closed successfully");
        }
    } else {
        log("Failed to connect to server");
    }
}

// Main async function
async fn main(): void {
    log("=== std:net Module Test Suite ===\n");

    // Test HTTP operations
    await testHttpGet();
    await testHttpPost();

    // Test TCP operations
    await testTcpClient();

    log("\n=== Test Suite Complete ===");
}

// Run main
await main();
